---
title: "4.1_narrow_cohort"
author: "Niklas Rindtorff"
date: "4/15/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(tidyverse)
library(stringr)
library(here)
```

# Import data

```{r}
load(here("data/crxg.Rdata"))
load(here("data/mutation.Rdata"))
load(here("data/cnv.Rdata"))
covariates <- read_csv(here("data/covariates.csv"))
```

# Select subgroups

```{r}
na_zero <- function(vector){
  tibble(vector) %>% 
    mutate(imputed = if_else(is.na(vector), 0, vector)) %>% 
    .$imputed %>% 
    return()
}

# grouping <- cnv %>% 
#   mutate(cosmic_id = as.character(cosmic_id)) %>%
#   semi_join(crxg %>% mutate(cosmic_id = as.character(cosmic_id))) %>% 
#   left_join(covariates %>% mutate(cosmic_id = as.character(cosmic_id)) %>% 
#               dplyr::select(-medium, -adherent, -semi_adherent, -suspension)) %>% 
#   left_join(mutation %>% mutate(cosmic_id = as.character(cosmic_id))) %>% 
#   mutate_all(funs(as.character)) %>%
#   mutate_all(funs(as.numeric)) %>% 
#   mutate_all(funs(na_zero))

grouping <- covariates %>% mutate(cosmic_id = as.character(cosmic_id)) %>% 
              dplyr::select(-medium, -adherent, -semi_adherent, -suspension) %>%
  semi_join(crxg %>% mutate(cosmic_id = as.character(cosmic_id)), by = "cosmic_id") %>% 
  left_join(mutation %>% mutate(cosmic_id = as.character(cosmic_id)), by = "cosmic_id") %>% 
  mutate_all(funs(as.character)) %>%
  mutate_all(funs(as.numeric)) %>% 
  mutate_all(funs(na_zero))
```

I identified 786 features which can be used to classify cell lines. 


```{r}
n_total <- nrow(grouping)

grouping_long <- grouping %>% 
  mutate_all(funs(as.character)) %>%
  mutate_all(funs(as.numeric)) %>%
  gather(feature, value, -cosmic_id)
  
grouping_order <- grouping_long %>% 
  count(feature, value) %>% 
  nest(-feature) %>% 
  mutate(count = purrr::map(data, ~ min(.x$n))) %>% 
  unnest(count) %>% 
  mutate(percent = round(100*(count/n_total), 2)) %>% 
  arrange((percent)) %>% 
  mutate(feature = factor(feature) %>% fct_inorder())

saveRDS(grouping_long, here("data/grouping_long.Rds"))
```


```{r}
grouping_order_f <- grouping_order %>% 
  filter(percent > 2) %>%
  mutate(cnv_helper = str_count(feature, pattern = "_")) %>% 
  filter(cnv_helper != 2) %>% 
  filter(feature != 'DDX5') %>% 
  dplyr::select(-data, -cnv_helper)

grouping_order_f %>% 
  #filter(percent > 2) %>%
  ggplot(aes(feature, percent)) + 
  geom_point() + 
  coord_flip() + 
  theme_classic() + 
  scale_y_log10() + 
  labs(y = "Percent size of smallest group") +
  ggsave("features.pdf", width = 3, height = 3)
```

```{r}
features <- c(grouping_order_f %>% 
                 
                
                filter(feature != 'HSPA8') %>% 
                .$feature %>% as.character())

grouping %>% 
  dplyr::select(-cosmic_id) %>%
  dplyr::select_(.dots = features) %>%
  pheatmap::pheatmap(show_rownames = FALSE,
                     show_colnames = FALSE)
```

Now, I use a function to run correlations on drug response for cell lines that are stratified by a given feature. I also run a pan-cancer correlation. 

I start with the pan-cancer correlation 

```{r}
pancancer_correlation <- function(drug_df, method_in = "spearman"){
  drug_anno <- drug_df %>% dplyr::select(drug_name, drug_id, target_pathway) %>% distinct()
  #print(feature_input)
  
  result <- drug_df %>%
  #semi_join(groups %>% filter(feature == feature_input, value == 1), by = "cosmic_id") %>%
  dplyr::select(norm_ln_ic50, drug_id, cosmic_id) %>% 
  mutate_all(funs(na_zero)) %>%
  spread(drug_id, norm_ln_ic50) %>%
  dplyr::select(-cosmic_id) %>%
  corrr::correlate(method = method_in) %>% 
  corrr::shave() %>% 
  corrr::stretch() %>% 
  drop_na() %>% 
  mutate(drug_id = x %>% as.numeric()) %>% 
  left_join(drug_anno, by = "drug_id") %>% 
  distinct() %>% 
  dplyr::select(-drug_id, drug_name_x = drug_name, target_pathway_x = target_pathway) %>% 
  mutate(drug_id = y %>% as.numeric()) %>% 
  left_join(drug_anno, by = "drug_id") %>% 
  distinct() %>% 
  dplyr::select(-drug_id, drug_name_y = drug_name, target_pathway_y = target_pathway) %>% 
  mutate(feature = "pan_cancer") 
  
  return(result)
}

cor_pan <- pancancer_correlation(drug_df = crxg, method_in = "pearson")
saveRDS(cor_pan, here("data/cor_pan.Rds"))
```

I create a plot of the correlation of pan-cancer vulnerabilities 

```{r}
pancancer_plot <- function(drug_df, method_in = "spearman"){

  result <- drug_df %>%
  #semi_join(groups %>% filter(feature == feature_input, value == 1), by = "cosmic_id") %>%
  dplyr::select(norm_ln_ic50, drug_id, cosmic_id) %>% 
  mutate_all(funs(na_zero)) %>%
  spread(drug_id, norm_ln_ic50) %>%
  dplyr::select(-cosmic_id) %>% 
    cor(method = method_in, use = "pairwise.complete.obs") %>% 
    pheatmap::pheatmap()
}

pancancer_plot(drug_df = crxg, method_in = "pearson")
```


```{r, eval = FALSE}
iterate_correlation <- function(feature_input, drug_df, groups, method_in = "spearman"){
  drug_anno <- drug_df %>% dplyr::select(drug_name, drug_id, target_pathway) %>% distinct()
  print(feature_input)
  
  result <- drug_df %>% 
  semi_join(groups %>% filter(feature == feature_input, value == 1), by = "cosmic_id") %>% 
  dplyr::select(norm_ln_ic50, drug_id, cosmic_id) %>% 
  mutate_all(funs(na_zero)) %>%
  spread(drug_id, norm_ln_ic50) %>%
  dplyr::select(-cosmic_id) %>%
  corrr::correlate(method = method_in) %>% 
  corrr::shave() %>% 
  corrr::stretch() %>% 
  drop_na() %>% 
  mutate(drug_id = x %>% as.numeric()) %>% 
  left_join(drug_anno, by = "drug_id") %>% 
  distinct() %>% 
  dplyr::select(-drug_id, drug_name_x = drug_name, target_pathway_x = target_pathway) %>% 
  mutate(drug_id = y %>% as.numeric()) %>% 
  left_join(drug_anno, by = "drug_id") %>% 
  distinct() %>% 
  dplyr::select(-drug_id, drug_name_y = drug_name, target_pathway_y = target_pathway) %>% 
  mutate(feature = feature_input) 
  
  return(result)
}

cor_iter <- features %>% 
  lapply(iterate_correlation, drug_df = crxg, groups = grouping_long, method_in = "pearson")
  #parallel::mclapply(iterate_correlation, drug_df = crxg, groups = grouping_long)

cor_iter_df <- cor_iter %>% bind_rows()
saveRDS(cor_iter_df, here("data/cor_iter.Rds"))
```


```{r}
readRDS(here("data/cor_iter.Rds"))

cor_iter_df_f <- cor_iter_df %>% 
  left_join(grouping_order %>% 
  dplyr::select(feature, percent_feature = percent)) %>% 
  mutate(log_percent_feature = log(percent_feature))
```

```{r}
plot_correlation<- function(var1, var2, df = crxg){
  df %>% 
    filter(drug_id == var1 | drug_id == var2) %>% 
    select_(.dots = c("drug_id", "cosmic_id", "norm_ln_ic50")) %>% 
    spread(drug_id, norm_ln_ic50) %>% 
    magrittr::set_colnames(c("cosmic_id", "drug_1", "drug_2")) %>%
    ggplot(aes(drug_1, drug_2)) +
      geom_point() + 
      theme_classic() + 
    labs()
}

plot_correlation(var1 = 272, var2 =274)

plot_correlation(var1 = 326, var2 =1526)

plot_correlation(var1 = 133, var2 =134)
```


I determine the percentage of available drug response data and add it to the model. 

```{r}
df <- crxg %>% 
  dplyr::select(norm_ln_ic50, drug_id, cosmic_id) %>% 
  #mutate_all(funs(na_zero)) %>%
  spread(drug_id, norm_ln_ic50) 

percent_drug <- colSums(is.na(df)) %>% 
  tibble(n_miss = .,
         drug_id = names(.)) %>% 
  filter(drug_id != "cosmic_id") %>% 
  mutate(percent_drug = n_miss/n_total) %>% 
  dplyr::select(drug_id, percent_drug)

cor_iter_df_fd <- cor_iter_df_f %>% 
  mutate(drug_id = x) %>% 
  left_join(percent_drug, by = "drug_id") %>%
  select(-drug_id, percent_drug_x = percent_drug) %>%
  mutate(drug_id = y) %>% 
  left_join(percent_drug, by = "drug_id") %>%
  select(-drug_id, percent_drug_y = percent_drug)
  
```

I save the current object. 

```{r}
saveRDS(cor_iter_df_fd, here("data/cor_iter_df_fd.Rds"))
```


I am interested in the effect of the feature abundance on the correlation coefficients. 

```{r}
cor_iter_df_fd %>% 
  sample_frac(0.01) %>%
  filter(percent_feature > 2) %>%
  ggplot(aes(percent_feature, r)) + 
  geom_point(alpha = 0.8) + 
  theme_bw() + 
  scale_x_log10() + 
  geom_smooth()
```




```{r}
cor_iter_df_fd %>% 
  sample_frac(0.01) %>%
  mutate(percent_drug = percent_drug_x + percent_drug_y) %>%
  ggplot(aes(percent_drug, r)) + 
  geom_point() + 
  theme_classic() + 
  scale_x_log10() + 
  geom_smooth() + 
  labs()
```




## Drug class correlatio

## Write database

The database consists of the following tables 
* drug_response 
* cnv
* mutation
* expression
* cell_metadata
* correlation

```{r}

```


